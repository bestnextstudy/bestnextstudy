library(shiny)
library( shinyWidgets )
# Installing `devtools` package if not alredy installed
if(!require(devtools)){
  install.packages("devtools")
  library(devtools)
}

#Installing `bestnextstudy` package
devtools::install_github("bestnextstudy/bestnextstudy")
library(bestnextstudy)
library(bestnextstudy)
not_sel <- "Not Selected"


main_page <- tabPanel(
  title = "Calculate A-Efficiency and D-Efficiency",
  titlePanel("Calculate A-Efficiency and D-Efficiency"),
  sidebarLayout(
    sidebarPanel(
      title = "Inputs",
      fileInput("csv_input", "Select CSV File to Import", accept = ".csv"),
      selectInput("corrvar", "Variable which represents the Correlation", choices = c(not_sel)),
      selectInput("year", "Variable which represents the Year", choices = c(not_sel)),
      br(),
      actionButton("run_button", "Run Analysis", icon = icon("play"))
    ),
    mainPanel(
      tabsetPanel(
        tabPanel(
          title = "Efficiency",
          verbatimTextOutput('contents'),
          tableOutput("efficiency_table")

        )
      )
    )
  )
)



create_efficiency_table <- function(data_input, corrvar, year){
  if(corrvar != not_sel & year!=not_sel ){
    variables  = names(data_input)
    variables <- variables[variables != corrvar]
    variables <- variables[variables != year]
    eff = bestnextstudy::efficiency(data = data_input, variables = variables, corrvar = corrvar)
    data.table(eff)
  }
}

create_next_best_study_table_a_eff <- function(data_input, corrvar, year,n_best ){
  if(corrvar != not_sel & year!=not_sel ){
    variables  = names(data_input)
    variables <- variables[variables != corrvar]
    variables <- variables[variables != year]
    eff = bestnextstudy::efficiency(data = data_input, variables = variables, corrvar = corrvar)
    data.table(eff)
  }
}

create_next_best_study_table_d_eff <- function(data_input, corrvar, year,n_best ){
  if(corrvar != not_sel & year!=not_sel ){
    variables  = names(data_input)
    variables <- variables[variables != corrvar]
    variables <- variables[variables != year]
    eff = bestnextstudy::efficiency_next_best_studies(data = data_input, variables = variables, corrvar = corrvar,nstudies_add =n_best )
    data.table(eff)
  }
}


design_test <- tabPanel(title = "Check Efficiency By Adding Your Own Design")
next_best_study <- tabPanel(title = "Next Best Studies")


next_best_study <- tabPanel(
  title = "Next Best Studies",
  titlePanel("Calculate A-Efficiency and D-Efficiency"),
  sidebarLayout(
    sidebarPanel(
      title = "Inputs",
      fileInput("csv_input", "Select CSV File to Import", accept = ".csv"),
      selectInput("corrvar", "Variable which represents the Correlation", choices = c(not_sel)),
      selectInput("year", "Variable which represents the Year", choices = c(not_sel)),
      numericInput(inputId = "n_best",label = "Number of Next Best Studies: \n (between 1 to 20)", value =NA, min = 1, max = 20),
      br(),
      actionButton("run_button", "Run Analysis", icon = icon("play"))
    ),
    mainPanel(
      tabsetPanel(
        tabPanel(
          title = "Next Best Studies",
          verbatimTextOutput('contents'),
          tableOutput("next_best_study_table")

        )
      )
    )
  )
)


####################################
# User interface                   #
####################################


ui <- navbarPage(
  title = "BestNextStudy",
  theme = shinytheme("flatly"),
  main_page ,
  design_test,
  next_best_study
)



server <- function(input, output){

  options(shiny.maxRequestSize=10*1024^2)

  data_input <- reactive({
    req(input$csv_input)
    fread(input$csv_input$datapath)
  })

  observeEvent(data_input(),{
    choices <- c(not_sel,names(data_input()))
    updateSelectInput(inputId = "corrvar", choices = choices)
    updateSelectInput(inputId = "year", choices = choices)
  })

  corrvar <- eventReactive(input$run_button,input$corrvar)
  year <- eventReactive(input$run_button,input$year)

  # Efficiency

  efficiency_table <- eventReactive(input$run_button,{
    create_efficiency_table(data_input(), corrvar(),year())
  })
  output$efficiency_table <- renderTable(efficiency_table())
  # Status/Output Text Box
  output$contents <- renderPrint({
    if (input$run_button>0) {
      isolate("Calculation complete.")
    } else {
      return("Server is ready for calculation.")
    }
  })

}


shinyApp(ui = ui, server = server)
